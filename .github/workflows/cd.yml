name: CD

on:
  push:
    branches: ["continuous-deployment-workflow"]
  workflow_dispatch:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0

      - name: Get version from manifest
        id: get_version
        run: |
          VERSION=$(jq -r .version src/manifest.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Determine Release Metadata
        id: metadata
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
          else
            BRANCH="${{ github.ref_name }}"
            SHA="${{ github.sha }}"
          fi
          
          VERSION=${{ env.VERSION }}
          SHA_SHORT=$(echo $SHA | cut -c1-7)
          
          if [ "$BRANCH" = "main" ]; then
            TAG="v$VERSION"
            TITLE="Stable Release v$VERSION"
            IS_PRERELEASE="false"
            STABILITY="stable"
          else
            TAG="v$VERSION-experimental-$SHA_SHORT"
            TITLE="Experimental Release: $BRANCH @ $SHA_SHORT"
            IS_PRERELEASE="true"
            STABILITY="experimental"
          fi
          
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_ENV
          echo "STABILITY=$STABILITY" >> $GITHUB_ENV

      - name: Check if Version already released (Main Branch only)
        if: env.STABILITY == 'stable'
        run: |
          if git rev-parse "${{ env.TAG }}" >/dev/null 2>&1; then
            echo "::error::Version $VERSION has already been released (tag ${{ env.TAG }} exists). Please bump the version in manifest.json before pushing to main."
            exit 1
          fi

      - name: Package extension
        run: |
          npm run package

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TITLE }}
          prerelease: ${{ env.IS_PRERELEASE == 'true' }}
          files: tl-dv-transcript-grabber.zip
          body: |
            ## Release Details
            - **Version:** ${{ env.VERSION }}
            - **Stability:** ${{ env.STABILITY == 'stable' && 'âœ… Stable' || 'ðŸ§ª Experimental' }}
            - **Branch:** `${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}`
            - **Commit:** ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
            
            *Automatically generated by CD workflow.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
